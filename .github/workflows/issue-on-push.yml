name: Create Issue from Commit and Link to Project

on:
  push:
    branches:
      - main

permissions:
  contents: read
  issues: write

jobs:
  create_issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2  # 변경 사항을 확인하기 위해 최소한의 깊이 설정

      - name: Get changed files
        id: changed-files
        run: |
          echo "::set-output name=list::$(git diff --name-only HEAD^ HEAD | xargs -I {} echo \"- {}\" | tr '\n' ',')"

      - name: Get last commit message
        id: last-commit-message
        run: echo "::set-output name=message::$(git log -1 --pretty=%B)"

      - name: Create Issue
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            async function run() {
              // UTC 시간을 기준으로 현재 시간을 가져온 후, KST로 변환 (UTC+9)
              const now = new Date();
              now.setHours(now.getHours() + 9); // KST로 변환
              const formattedNow = now.toISOString().replace('T', ' ').substring(0, 16).replace('Z', '');

              const commitMessage = `${process.env.COMMIT_MESSAGE}`;
              const changedFiles = process.env.CHANGED_FILES.split(',').join('\\n');

              const issueTitle = `[${formattedNow} KST] ${commitMessage}`;
              const issueBody = `This issue is automatically generated from the last commit on the main branch.\\n\\n### Changed Files:\\n${changedFiles}`;

              const response = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['auto-generated'],
              });

              console.log(`Issue created: ${response.data.html_url}`);
            }
            
            run().catch(err => console.error(err));
        env:
          COMMIT_MESSAGE: ${{ steps.last-commit-message.outputs.message }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.list }}
